<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://lasker-studio-cep.vercel.app; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://lasker-studio-cep.vercel.app; style-src 'self' 'unsafe-inline' https://lasker-studio-cep.vercel.app; connect-src *; img-src 'self' data: https:; font-src 'self' https:;">
    <title>Lasker Studio CEP</title>

    <style>
      body {
        margin: 0;
        background: #1a1a1a;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      }
      #app {
        min-height: 100vh;
      }
      .loader {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        color: #888;
      }
      .loader-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid #333;
        border-top-color: #61dafb;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      .loader-text {
        margin-top: 16px;
        font-size: 14px;
      }
      .loader-error {
        color: #ff6b6b;
        text-align: center;
        padding: 20px;
      }
      .loader-retry {
        margin-top: 12px;
        padding: 8px 16px;
        background: #333;
        border: 1px solid #555;
        color: #fff;
        border-radius: 4px;
        cursor: pointer;
      }
      .loader-retry:hover {
        background: #444;
      }
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="loader">
        <div class="loader-spinner"></div>
        <div class="loader-text">Loading...</div>
      </div>
    </div>

    <script>
      (function() {
        var CDN_BASE = 'https://lasker-studio-cep.vercel.app';
        var MANIFEST_URL = CDN_BASE + '/manifest.json';
        var CACHE_KEY = 'lasker_studio_cache';

        function showError(message) {
          var app = document.getElementById('app');
          app.innerHTML =
            '<div class="loader">' +
              '<div class="loader-error">' +
                '<p>' + message + '</p>' +
                '<button class="loader-retry" onclick="location.reload()">Retry</button>' +
              '</div>' +
            '</div>';
        }

        function updateLoaderText(text) {
          var loaderText = document.querySelector('.loader-text');
          if (loaderText) loaderText.textContent = text;
        }

        function loadScript(url) {
          return new Promise(function(resolve, reject) {
            var script = document.createElement('script');
            script.type = 'module';
            script.src = url;
            script.onload = resolve;
            script.onerror = reject;
            document.body.appendChild(script);
          });
        }

        function loadStyle(url) {
          return new Promise(function(resolve, reject) {
            var link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = url;
            link.onload = resolve;
            link.onerror = reject;
            document.head.appendChild(link);
          });
        }

        function getCache() {
          try {
            var cached = localStorage.getItem(CACHE_KEY);
            return cached ? JSON.parse(cached) : null;
          } catch (e) {
            return null;
          }
        }

        function setCache(manifest) {
          try {
            localStorage.setItem(CACHE_KEY, JSON.stringify(manifest));
          } catch (e) {}
        }

        function loadApp(manifest) {
          var files = manifest.files.main;
          updateLoaderText('Loading app v' + manifest.version + '...');

          Promise.all([
            loadStyle(CDN_BASE + '/' + files.css),
            loadScript(CDN_BASE + '/' + files.js)
          ])
          .then(function() {
            setCache(manifest);
          })
          .catch(function(err) {
            showError('Failed to load app resources');
            console.error('Load error:', err);
          });
        }

        function fetchManifest() {
          updateLoaderText('Checking for updates...');

          fetch(MANIFEST_URL + '?t=' + Date.now())
            .then(function(res) {
              if (!res.ok) throw new Error('HTTP ' + res.status);
              return res.json();
            })
            .then(function(manifest) {
              loadApp(manifest);
            })
            .catch(function(err) {
              console.warn('Manifest fetch failed:', err);
              var cached = getCache();
              if (cached) {
                updateLoaderText('Offline mode - using cached v' + cached.version);
                setTimeout(function() { loadApp(cached); }, 500);
              } else {
                showError('Cannot connect to server.<br>Please check your internet connection.');
              }
            });
        }

        // Start loading
        fetchManifest();
      })();
    </script>
  </body>
</html>
